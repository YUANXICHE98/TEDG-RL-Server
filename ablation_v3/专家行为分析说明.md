# 专家行为分析说明

## 📊 当前状态

### 已完成的可视化

✅ **综合对比图** (`comprehensive_comparison.png`)
- 12个子图的完整对比
- 分数、奖励、分布等指标
- **缺少**: 专家行为分析（第4行的3个子图是占位符）

### 缺失的数据

❌ **专家激活数据**
- Alpha值（每个step的专家权重）
- Alpha熵（专家专业化程度）
- 专家-场景对应关系

**原因**: 训练日志只记录了episode级别的指标，没有记录step级别的专家激活数据。

## 🎯 需要的专家行为分析

### 1. 专家激活模式

**目标**: 显示4个专家在不同时刻的激活强度

**可视化**:
```
热力图 (Heatmap)
- X轴: Episode或Time Step
- Y轴: Expert 0, 1, 2, 3
- 颜色: 激活强度 (0-1)
```

**需要的数据**:
- 每个step的alpha值: `[α₀, α₁, α₂, α₃]`
- 记录多个episodes的激活模式

### 2. 场景-专家对应

**目标**: 分析哪个专家负责哪种游戏场景

**可视化**:
```
场景分类图
- 战斗场景 → Expert X
- 探索场景 → Expert Y
- 物品管理 → Expert Z
- 逃跑/治疗 → Expert W
```

**需要的数据**:
- 游戏状态信息（怪物、血量、物品等）
- 对应时刻的专家激活
- 采取的动作

### 3. 专家切换频率

**目标**: 显示专家切换的频率和模式

**可视化**:
```
时间序列图
- 显示主导专家随时间的变化
- 统计切换频率
- 分析切换模式
```

**需要的数据**:
- 每个step的主导专家（argmax(alpha)）
- 切换点标记

## 🔧 如何获取专家激活数据

### 方案1: 修改训练脚本记录

**修改**: `ablation_v3/train/train_v3_gat_moe.py`

```python
# 在训练循环中添加
if step % 10 == 0:  # 每10步记录一次
    alpha_values = router.get_alpha()  # 获取当前alpha
    log_data['step_alpha'].append({
        'episode': episode,
        'step': step,
        'alpha': alpha_values.tolist(),
        'state_info': extract_state_info(obs)
    })
```

**优点**: 实时记录，数据完整
**缺点**: 需要重新训练

### 方案2: 从Checkpoint加载推理

**工具**: 创建 `tools/analyze_expert_behavior.py`

```python
# 伪代码
def analyze_expert_behavior(checkpoint_path, num_episodes=10):
    # 1. 加载模型
    model = load_checkpoint(checkpoint_path)
    
    # 2. 运行episodes
    for ep in range(num_episodes):
        obs = env.reset()
        episode_data = []
        
        while not done:
            # 3. 记录专家激活
            with torch.no_grad():
                alpha = model.router.get_alpha(obs)
                action = model.select_action(obs)
            
            episode_data.append({
                'step': step,
                'alpha': alpha,
                'state': extract_state_info(obs),
                'action': action
            })
            
            obs, reward, done = env.step(action)
        
        # 4. 分析和可视化
        visualize_episode_experts(episode_data)
```

**优点**: 不需要重新训练，可以分析现有checkpoint
**缺点**: 只能分析少量episodes

### 方案3: 使用现有的可视化工具

**已有工具**:
- `tools/visualize_expert_specialization.py`: 可视化专家专业化
- `tools/analyze_expert_activation.py`: 分析专家激活
- `tools/visualize_v3_episode.py`: 可视化单个episode

**问题**: 这些工具需要alpha熵数据，但当前训练日志中alpha熵都是0。

## 📝 推荐方案

### 短期方案（立即可做）

**使用方案2**: 从现有checkpoint加载并推理

1. 创建分析脚本:
```bash
# 创建 tools/analyze_expert_behavior.py
python3 tools/analyze_expert_behavior.py \
  --checkpoint ablation_v3/results/resume_500_from_100/checkpoints/checkpoint_500.pt \
  --num-episodes 20 \
  --output ablation_v3/visualizations/expert_behavior/
```

2. 生成可视化:
- 专家激活热力图
- 场景-专家对应图
- 专家切换频率图

3. 集成到综合对比图:
- 更新 `tools/visualize_comprehensive_comparison.py`
- 填充第4行的3个占位符子图

### 长期方案（后续训练）

**使用方案1**: 修改训练脚本

1. 在 `train_v3_gat_moe.py` 中添加step级别的记录
2. 记录alpha值、状态信息、动作
3. 在训练过程中实时分析专家行为
4. 生成更详细的专家行为报告

## 🚀 下一步行动

### 立即可做

1. **创建专家行为分析脚本**
```bash
# 需要创建
tools/analyze_expert_behavior.py
```

2. **从checkpoint加载并推理**
```bash
python3 tools/analyze_expert_behavior.py \
  --checkpoint ablation_v3/results/resume_500_from_100/checkpoints/checkpoint_500.pt
```

3. **生成专家行为可视化**
- 热力图
- 场景对应图
- 切换频率图

4. **更新综合对比图**
- 填充占位符子图
- 完整的12子图可视化

### 后续训练

1. **修改训练脚本**
- 添加step级别的alpha记录
- 记录状态信息

2. **实时分析**
- 训练过程中分析专家行为
- 生成专家专业化报告

3. **完整对比**
- Baseline vs Manager的专家行为对比
- 不同训练阶段的专家演化

## 📚 相关文档

- **综合对比图**: `ablation_v3/visualizations/comprehensive_comparison/comprehensive_comparison.png`
- **对比结果**: `ablation_v3/500EP_COMPARISON_RESULTS.md`
- **可视化说明**: `ablation_v3/VISUALIZATION_EXPLANATION.md`
- **专家激活分析**: `ablation_v3/EXPERT_ACTIVATION_ANALYSIS.md`

## ✅ 总结

**当前状态**:
- ✅ 已完成分数、奖励、分布等基础对比
- ❌ 缺少专家行为分析（数据不足）

**推荐方案**:
- 🎯 短期: 从checkpoint加载推理，生成专家行为分析
- 🚀 长期: 修改训练脚本，实时记录专家激活数据

**预期效果**:
- 完整的12子图综合对比
- 清晰的专家-场景对应关系
- 专家专业化程度量化分析

---

**生成时间**: 2026-01-13  
**状态**: 📋 待实现  
**优先级**: 中等（基础对比已完成，专家分析可后续补充）
